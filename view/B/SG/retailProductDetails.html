<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Retail Product Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        .btn-primary {
            background: #007bff;
            border: none;
            color: #fff;
            padding: 8px 12px;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .favorite-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        
        .favorite-btn:hover {
            transform: scale(1.1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }

        .review-overview {
            flex: 0 0 220px;
        }

        .review-overview .average {
            font-size: 2.5em;
            font-weight: bold;
        }

        .review-overview .stars {
            font-size: 1.4em;
            color: #f0c14b;
        }

        .review-overview .count {
            margin-top: 5px;
            font-size: 1em;
        }

        .rating-bars {
            margin-top: 15px;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .rating-bar span {
            width: 25px;
            font-size: 0.9em;
        }

        .rating-fill {
            background: #007bff;
            height: 6px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .review-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .review-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            flex: 1 1 250px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .review-card h4 {
            font-size: 1em;
            margin: 0 0 5px;
        }

        .review-stars {
            color: #f0c14b;
            margin-bottom: 8px;
        }

        .review-meta {
            font-size: 0.85em;
            color: #777;
        }

        .star-rating {
            direction: rtl;
            display: inline-flex;
            font-size: 2em;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating input:checked~label,
        .star-rating label:hover,
        .star-rating label:hover~label {
            color: #f0c14b;
        }

        #favoriteNotification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #5a8f29;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reviews-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
    </style>
    <script src="../checkCountry.js"></script>
</head>

<body>
    <script src="../../header.js"></script>
    <div class="body">
        <script src="menu2.js"></script>
        <div role="main" class="main">
            <section class="page-top">
                <div class="container">
                    <div class="row">
                        <div class="col-md-12">
                            <h2>Retail Products</h2>
                        </div>
                    </div>
                </div>
            </section>
            <div class="container">
                <hr class="tall">
                <div class="row">
                    <div class="col-md-6">
                        <div>
                            <div class="thumbnail">
                                <img alt="" class="img-responsive img-rounded" id="productImg">
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="summary entry-summary">
                            <!-- Header with product name and heart icon will be inserted here -->
                            <p class="price"><h4 class="amount" id="productPrice"></h4></p>
                            <strong>Description</strong>
                            <p class="taller" id="productDesc"></p>
                            <div class="product_meta">
                                <span class="posted_in">Category: <a rel="tag" id="productCategory"></a></span>
                            </div>
                            <br/><br/>

                            <div class="row">
                                <div class="col-md-4">
                                    <form onsubmit="return false;">
                                        View Item Availability<br/>
                                        <select style="color: black;" name="storeID" id="storeID"></select><br/><br/>
                                        <input type="submit" onclick="CheckItemAvail()" class="btn btn-primary btn-icon" value="Check Item Availability"/>
                                    </form>
                                </div>
                                <div id="quantityDiv"></div>
                            </div>
                            <div class="row" style="margin-top: 20px;">
                                <div class="col-md-12">
                                    <button class="btn btn-primary" onclick="addToCartFromPage()">Add to Cart</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reviews Section -->
                <div class="reviews-section">
                    <div class="row">
                        <div class="col-md-12">
                            <h3>Customer Reviews</h3>
                            <div id="reviewStats" class="review-overview"></div>
                            <div id="writeReviewContainer" style="margin-top:20px;"></div>
                            <div id="reviewsContainer" class="review-cards"></div>
                        </div>
                    </div>
                </div>
                <hr class="tall">
            </div>
        </div>
        <script src="../footer.js"></script>
    </div>

    <script>
        var countryPrefix = localStorage.getItem('urlPrefix');
        var currentUrl = new URL(window.location.href);
        var sku = currentUrl.searchParams.get("sku");
        var memberEmail = sessionStorage.getItem('memberEmail');
        if(sku == null || sku == '') {
            window.location.href = '/B/' + countryPrefix + '/index.html';
        }
        var countryId = localStorage.getItem('countryId');
        var currentProduct = null;
        
        // Reviews API
        const reviewsApiBase = "/api/reviews";
        const reviewSku = sku;
        
        fetch(new Request('/api/getRetailProductBySku?sku=' + sku + '&countryId=' + countryId,
            {
                method: 'GET'
            })).then(function (response) {
                return response.json();
            }).then(function (product) {
                currentProduct = product;
                // Set product details
                document.getElementById("productImg").setAttribute('src', product.imageURL);
                
                // Create header container
                var headerContainer = document.createElement('div');
                headerContainer.style.display = 'flex';
                headerContainer.style.justifyContent = 'space-between';
                headerContainer.style.alignItems = 'center';
                headerContainer.style.width = '100%';
                headerContainer.style.marginBottom = '15px';
                
                // Product name
                var nameElement = document.createElement('h2');
                nameElement.className = 'shorter';
                nameElement.style.margin = '0';
                nameElement.innerHTML = '<strong>' + product.name + '</strong>';
                headerContainer.appendChild(nameElement);
                
                // Add favorite button if logged in
                if(memberEmail != null && memberEmail != '') {
                    var favoriteBtn = document.createElement('button');
                    favoriteBtn.className = 'favorite-btn';
                    favoriteBtn.innerHTML = 'ü§ç';
                    favoriteBtn.onclick = function() {
                        toggleFavorite(product);
                    };
                    headerContainer.appendChild(favoriteBtn);
                    updateFavoriteButton(product.id);
                }

                // Add header container to the page
                var summaryDiv = document.querySelector('.summary.entry-summary');
                summaryDiv.insertBefore(headerContainer, summaryDiv.firstChild);

                document.getElementById("productPrice").innerHTML = '$' + product.price;
                document.getElementById("productDesc").innerHTML = product.description;
                document.getElementById("productCategory").innerHTML = product.category;
                document.getElementById("productCategory").setAttribute('href', '/B/' + countryPrefix
                    + '/retailProductsCategory.html?cat=' + encodeURIComponent(product.category));

                // Store selection
                var selectOptions = '<option></option>';
                var storeID = currentUrl.searchParams.get("storeID");
                var storesInCountry = JSON.parse(localStorage.getItem('storesInCountry'));
                for (i = 0; i < storesInCountry.length; i++) {
                    var store = storesInCountry[i];
                    if(store.id == storeID) {
                        selectOptions += '<option selected value="' + store.id + '">' + store.name + '</option>';
                    }
                    else {
                        selectOptions += '<option value="' + store.id + '">' + store.name + '</option>';
                    }
                }
                document.getElementById("storeID").innerHTML = selectOptions;

                // Quantity display
                var quantityDivTxt = 'Status: ';
                var itemQty = currentUrl.searchParams.get("itemQty");
                if(itemQty != null) {
                    quantityDivTxt += itemQty > 0 ? 'Available':'Unavailable';
                    quantityDivTxt += '<br/>Remaining Qty: ' + itemQty;
                    document.getElementById("quantityDiv").innerHTML = '\
                        <div class="col-md-6">\
                            ' + quantityDivTxt + '\
                        </div>';
                }
                
                // Load reviews after product is loaded
                loadReviews();
            }).catch(function(error) {
                console.log(error);
            });

        function toggleFavorite(product) {
            var favorites = JSON.parse(sessionStorage.getItem('favorites')) || [];
            var existingIndex = favorites.findIndex(item => item.id === product.id);
            
            if (existingIndex >= 0) {
                favorites.splice(existingIndex, 1);
                showNotification(product.name + ' was removed from your favourites');
            } else {
                favorites.push({
                    id: product.id,
                    sku: product.sku,
                    name: product.name,
                    price: product.price,
                    imageURL: product.imageURL,
                    category: product.category,
                    type: 'retail'
                });
                showNotification(product.name + ' was added to your favourites', true);
            }
            
            sessionStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavoriteButton(product.id);
        }

        function updateFavoriteButton(itemId) {
            var favorites = JSON.parse(sessionStorage.getItem('favorites')) || [];
            var isFavorite = favorites.some(item => item.id === itemId);
            var favoriteBtn = document.querySelector('.favorite-btn');
            
            if (favoriteBtn) {
                favoriteBtn.innerHTML = isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
                favoriteBtn.style.color = isFavorite ? '#d9534f' : '#ccc';
            }
        }

        function showNotification(message, isAdded) {
            var existingNotification = document.getElementById("favoriteNotification");
            if (existingNotification) {
                existingNotification.remove();
            }
            
            var notification = document.createElement('div');
            notification.id = "favoriteNotification";
            notification.style.position = "fixed";
            notification.style.bottom = "20px";
            notification.style.right = "20px";
            notification.style.padding = "15px 20px";
            notification.style.backgroundColor = isAdded ? "#5a8f29" : "#333";
            notification.style.color = "white";
            notification.style.borderRadius = "4px";
            notification.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
            notification.style.zIndex = "1000";
            notification.style.display = "flex";
            notification.style.alignItems = "center";
            notification.style.gap = "10px";
            
            var icon = document.createElement('span');
            icon.innerHTML = isAdded ? '‚ù§Ô∏è' : 'üíî';
            notification.appendChild(icon);
            
            var text = document.createElement('span');
            text.textContent = message;
            notification.appendChild(text);
            
            if (isAdded) {
                var viewLink = document.createElement('a');
                viewLink.href = "/B/" + localStorage.getItem('urlPrefix') + "/favourites.html";
                viewLink.textContent = "View";
                viewLink.style.color = "white";
                viewLink.style.marginLeft = "15px";
                viewLink.style.textDecoration = "underline";
                notification.appendChild(viewLink);
            }
            
            document.body.appendChild(notification);
            
            setTimeout(function() {
                notification.style.transition = "opacity 0.5s";
                notification.style.opacity = "0";
                setTimeout(function() {
                    notification.remove();
                }, 500);
            }, 3000);
        }

        function addToCartFromPage() {
            if (currentProduct) {
                addToCart(currentProduct.sku, currentProduct.id, currentProduct.price, 
                         currentProduct.name, currentProduct.imageURL);
            }
        }

        function addToCart(sku, id, price, name, imageURL) {
            fetch(new Request('/api/getItemQuantity?sku=' + sku + '&storeId=-1',
            {
                method: 'GET'
            })).then(function (response) {
                return response.json();
            }).then(function (data) {
                var quantity = data[0].sum;
                if(quantity == null || quantity == '') {
                    var url = window.location.origin + window.location.pathname;
                    window.location.href = url + '?sku=' + sku + '&errMsg=Item not added to cart, not enough quantity available.';
                }
                else {
                    var allOk = true;
                    var shoppingCart = JSON.parse(sessionStorage.getItem('shoppingCart'));
                    if(shoppingCart == null || shoppingCart == '') {
                        shoppingCart = [];
                        shoppingCart.push({
                            id: id,
                            sku: sku,
                            price: price,
                            name: name,
                            imgURL: imageURL,
                            quantity: 1
                        });
                    }
                    else {
                        var exist = false;
                        for(i = 0; i < shoppingCart.length; i++) {
                            var cartItem = shoppingCart[i];
                            if(cartItem.sku == sku) {
                                if (shoppingCart[i].quantity == quantity) {
                                    var url = window.location.origin + window.location.pathname;
                                    window.location.href = url + '?sku=' + sku + '&errMsg=Item not added to cart, not enough quantity available.';
                                    exist = true;
                                    allOk = false;
                                }
                                else {
                                    shoppingCart[i].quantity += 1;
                                    exist = true;
                                }
                            }
                        }
                        if (!exist) {
                            shoppingCart.push({
                                id: id,
                                sku: sku,
                                price: price,
                                name: name,
                                imgURL: imageURL,
                                quantity: 1
                            });
                        }
                    }
                    if (allOk) {
                        sessionStorage.setItem('shoppingCart', JSON.stringify(shoppingCart));
                        var url = window.location.origin + window.location.pathname;
                        window.location.href = url + '?sku=' + sku + '&goodMsg=Successfully added!';
                    }
                }
            }).catch(function(error) {
                console.log(error);
            });
        }

        function CheckItemAvail() {
            var storeId = document.getElementById("storeID").value;
            if(storeId != null && storeId != '') {
                fetch(new Request('/api/getItemQuantity?sku=' + sku + '&storeId=' + storeId,
                {
                    method: 'GET'
                })).then(function (response) {
                    return response.json();
                }).then(function (data) {
                    var quantity = data[0].sum;
                    if(quantity == null || quantity == '') {
                        quantity = 0;
                    }
                    var url = window.location.origin + window.location.pathname;
                    window.location.href = url + '?sku=' + sku + '&itemQty=' + quantity + '&storeID=' + storeId;
                }).catch(function(error) {
                    console.log(error);
                });
            }
        }

        // Reviews functionality
        function loadReviews() {
            fetch(`${reviewsApiBase}/${encodeURIComponent(reviewSku)}`)
                .then(res => res.json())
                .then(reviews => {
                    if (!reviews || reviews.length === 0) {
                        document.getElementById("reviewsContainer").innerHTML = "<p>No reviews yet. Be the first to review this product!</p>";
                        document.getElementById("reviewStats").innerHTML = '<div class="average">‚Äì</div><div class="stars">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div><div class="count">0 Reviews</div>';
                        return;
                    }
                    
                    let total = 0, counts = [0, 0, 0, 0, 0];
                    reviews.forEach(r => { 
                        total += r.rating; 
                        counts[r.rating - 1]++; 
                    });
                    
                    const avg = (total / reviews.length).toFixed(1);
                    let bars = "";
                    for (let i = 5; i >= 1; i--) {
                        const pct = (counts[i - 1] / reviews.length) * 100;
                        bars += `<div class="rating-bar"><span>${i}‚òÖ</span><div class="rating-fill" style="width:${pct}%"></div></div>`;
                    }
                    
                    document.getElementById("reviewStats").innerHTML = `
                        <div class="average">${avg}</div>
                        <div class="stars">${"‚òÖ".repeat(Math.floor(avg))}${avg % 1 >= 0.5 ? "¬Ω" : ""}${"‚òÜ".repeat(5 - Math.ceil(avg))}</div>
                        <div class="count">${reviews.length} Reviews</div>
                        <div class="rating-bars">${bars}</div>`;

                    let html = "";
                    reviews.forEach(r => {
                        const canDelete = memberEmail && r.author === memberEmail;
                        html += `
                        <div class="review-card">
                            <h4>${r.title || "Customer Review"}</h4>
                            <div class="review-stars">${"‚òÖ".repeat(r.rating)}${"‚òÜ".repeat(5 - r.rating)}</div>
                            <p>${r.content || ""}</p>
                            <div class="review-meta">
                                ${r.author || "Anonymous"}
                                ${canDelete ? `<button class="btn-primary" onclick="deleteReview(${r.id})" style="float:right;">Delete</button>` : ""}
                            </div>
                        </div>`;
                    });
                    document.getElementById("reviewsContainer").innerHTML = html;
                })
                .catch(() => document.getElementById("reviewsContainer").innerHTML = "<p>Error loading reviews.</p>");

            // Setup review form
            if (!memberEmail) {
                document.getElementById("writeReviewContainer").innerHTML = `
                    <p><a href="/B/${countryPrefix}/login.html">Login to write a review</a></p>`;
            } else {
                document.getElementById("writeReviewContainer").innerHTML = `
                    <h4>Write a Review</h4>
                    <form onsubmit="return false;">
                        <label>Rating:</label><br/>
                        <div class="star-rating">
                            <input type="radio" id="star5" name="rating" value="5"><label for="star5">‚òÖ</label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
                            <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
                        </div><br/>
                        <label>Review Title:</label><br/>
                        <input id="reviewTitle" style="width:100%;"><br/><br/>
                        <label>Review (optional):</label><br/>
                        <textarea id="reviewContent" rows="4" style="width:100%;"></textarea><br/><br/>
                        <button class="btn btn-primary" onclick="submitReview()">Submit Review</button>
                        <div id="reviewError" style="color:red;margin-top:10px;"></div>
                    </form>`;
            }
        }

        function submitReview() {
            const ratingInput = document.querySelector('.star-rating input:checked');
            const rating = ratingInput ? parseInt(ratingInput.value) : 0;
            const title = document.getElementById("reviewTitle").value.trim();
            const content = document.getElementById("reviewContent").value.trim();
            const errorDiv = document.getElementById("reviewError");
            
            if (!rating) { 
                errorDiv.textContent = "Please select a rating."; 
                return; 
            }
            
            fetch(reviewsApiBase, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + sessionStorage.getItem("token")
                },
                body: JSON.stringify({ 
                    sku: reviewSku, 
                    rating, 
                    title, 
                    content 
                })
            })
            .then(async res => {
                if (!res.ok) {
                    const t = await res.text();
                    console.error("Submit failed:", res.status, t);
                    throw new Error("Submit failed.");
                }
                return res.json();
            })
            .then(() => {
                errorDiv.style.color = "green";
                errorDiv.textContent = "Review submitted!";
                setTimeout(() => window.location.reload(), 1000);
            })
            .catch(() => errorDiv.textContent = "Error submitting review.");
        }

        function deleteReview(id) {
            if (!confirm("Delete this review?")) return;
            fetch(`${reviewsApiBase}/${id}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + sessionStorage.getItem("token") }
            })
            .then(res => {
                if (!res.ok) throw new Error("Delete failed.");
                return res.json();
            })
            .then(() => window.location.reload())
            .catch(() => alert("Error deleting review."));
        }
    </script>
</body>
</html>
